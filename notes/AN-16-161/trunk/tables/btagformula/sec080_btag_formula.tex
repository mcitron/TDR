\section{The ``b-tag formula method''\label{sec:bjets}}

In order to maximise sensitivity to potential new physics signatures
in final states with multiple b-quark jets, a method that improves the
statistical power of the simulation, particularly for $\nb \geq 2$, is
employed. This method is known as the ``formula'' method. The
resulting improvement in the statistical precision of the simulation
propagates through to the transfer factors used in the analysis.

\subsection{Method}

The distribution of the number of bjets (\nb) is estimated from generator-level information
contained in the simulation. The number of reconstruction-level jets
matched to underlying bottom quarks ($\nb^{\rm gen}$), charm quarks
($n_{\rm c}^{\rm gen}$), and light-flavoured partons ($n_{\rm
  light}^{\rm gen}$) per event, $N(\nb^{\rm gen},n_{\rm c}^{\rm
  gen},n_{\rm light}^{\rm gen})$, is recorded in bins of (\njet
   , \scalht, \mht). 
 The matching between between truth-level partons
and reconstruction-level jets is achieved with a matching algorithm
recommended by the BTV POG~\cite{btagMCTools}.
 The b-tagging efficiency, $\epsilon$, and mistag probabilities,
$f_{\rm c}$ and $f_{\rm light}$, are also determined from simulation
in bins of (\njet,\scalht,\mht), with each quantity averaged
over jet $p_{\rm T}$ and $\eta$. Corrections are applied on a
jet-by-jet basis to both $\epsilon$, $f_{\rm c}$, and $f_{\rm light}$
in order to match the corresponding measurements from
data.%~\cite{Chatrchyan:2012jua}. %FIXME

The above information is sufficient to predict $\nb$ and thus also
determine the event yield $N(n_{\rm b})$ from simulation for a given
bin in (\njet,\scalht,\mht) with the expression:

\begin{equation}
  \label{equ:btag-formula}
  N(n_{\textrm{b}}) = \sum_{n_{\textrm{jet}}} \, \sum_{n_{\textrm{b}}}
  \left( \, N(n_{\textrm{b}}^{\textrm{gen}},
    n_{\textrm{c}}^{\textrm{gen}}, n_{\textrm{l}}^{\textrm{gen}})
    \times P_{\rm b} \times P_{\rm c} \times P_{\rm light} \, \right) \, , 
\end{equation}

with $n_{\textrm{b}}^{\textrm{tag}}$,
$n_{\textrm{c}}^{\textrm{tag}}$, and $n_{\textrm{q}}^{\textrm{tag}}$
defined the number of times that a reconstructed b-quark jet is identified
as originating from an underlying bottom quark, charm quark, or
light-flavoured parton, respectively, and $P_{\rm b} \equiv
P(n_{\textrm{b}}^{\textrm{tag}} ; n_{\textrm{b}}^{\textrm{gen}},
\epsilon)$, $P_{\rm c} \equiv P(n_{\textrm{c}}^{\textrm{tag}} ;
n_{\textrm{c}}^{\textrm{gen}}, f_{\rm c})$, and $P_{\rm light} \equiv
P(n_{\textrm{q}}^{\textrm{tag}} ; n_{\textrm{q}}^{\textrm{gen}},
f_{\rm light})$ as the binomial probabilities for this to happen.
The outer summation considers all possible combinations of
$n_{\textrm{b}}^{\textrm{gen}}$, $n_{\textrm{c}}^{\textrm{gen}}$, and
$n_{\textrm{q}}^{\textrm{gen}}$ that satisfy $n_{\textrm{jet}} =
n_{\textrm{b}}^{\textrm{gen}} + n_{\textrm{c}}^{\textrm{gen}} +
n_{\textrm{q}}^{\textrm{gen}}$ with $n_{\textrm{jet}}$ defined as the number 
of jets in the event, while the inner summation considers
all possible combinations of $n_{\textrm{b}}^{\textrm{tag}}$,
$n_{\textrm{c}}^{\textrm{tag}}$, and $n_{\textrm{q}}^{\textrm{tag}}$
that satisfy $n_{\textrm{b}} = n_{\textrm{b}}^{\textrm{tag}} +
n_{\textrm{c}}^{\textrm{tag}} + n_{\textrm{q}}^{\textrm{tag}}$.
  
The method exploits the ability to make precise measurements of
$N(n_{\rm b}^{\rm gen},n_{\rm c}^{\rm gen},n_{\rm light}^{\rm gen})$,
$\epsilon$, $f_{\rm c}$, and $f_{\rm light}$ independently of $n_{\rm
  b}$, which means that event yields for a given b-quark jet
multiplicity can be predicted with a higher statistical precision than
obtained directly from simulation. Precise measurements of $f_{\rm c}$
and $f_{\rm light}$ are particularly important for events with $n_{\rm
  b} \geq 3$, which often occur in the SM because of the presence of
mistagged jets in the event. In this case, the largest background is
\ttbar, with two correctly tagged b-quark jets and an additional
mistagged jet originating from a charm quark or light-flavoured
parton.

An alternative approach is simply to use simulation samples that
correspond to much larger integrated luminosities than the recorded
dataset, but this is unfeasible for most of the dominant background
processes, which have cross sections of tens of pb or significantly
higher.

\subsection{Validation}

Predictions from the formula method are used to construct transfer 
factors as described in Section~\ref{sec:backgroundmet} and \mht shape distribution
 as described in Section~\ref{sec:syst-on-shape}. In this sense, predictions from
 the formula method are treated in the same way as yields taken directly from MC
Simulation (raw MC) to preserve the 
 data-driven aspect of the background estimation, and any predictions are made
 with the extrapolation to high \nb bins on MC level only.

Figure~\ref{fig:mhtShape_ge5j_ge3b_ht800}, ~\ref{fig:mhtShape_ge5j_ge3b_ht600} and ~\ref{fig:mhtShape_ge5j_ge3b_ht800} 
compare the \nb~distributions between formula and . Figure~\ref{fig:pull} shows
the pull distribution of predictions from formula to raw MC, defined as the prediction from
 formula method and raw MC yields in each (\njet,\scalht,\mht) bin divided by statistical
 uncertainties. This demonstrates closure between formula and raw MC, as expected because 
 all the quantities in ~\ref{equ:btag-formula} are computed in MC simulations and 
 no data driven corrections, such as btag scale factors from BTV have been injected. 

Table~\ref{tab:formula-ge5j} compares
predictions from formula method to raw MC yields for the jet category \njet $\geq 5$. 
Statistical uncertainties are generally smaller with formula
method, and in some bins formula method allows extrapolation at high btag bins 
where raw MC suffers from low or even no statistic.

\input{tables/btagformula/BTagFormulaTable_SingleMu_ge5j.tex}

 \begin{figure}[h!]
  \centering
  \includegraphics[width=0.7\textwidth]{figures/btagformula/ge5j_800_0_Inc_GoodNb.pdf} 
  \caption{\label{fig:mhtShape_ge5j_ge3b_ht800} \nb~distribution from formula
   method (Blue) and raw MC (Red) for the bin \scalht~$800-\infty$, \njet $\geq 5$, inclusive
   in \mht.}
\end{figure}

 \begin{figure}[h!]
  \centering
  \includegraphics[width=0.7\textwidth]{figures/btagformula/ge5j_600_0_Inc_GoodNb.pdf} 
  \caption{\label{fig:mhtShape_ge5j_ge3b_ht600} \nb distribution from formula
   method (Blue) and raw MC (Red) for the bin \scalht~$600-800$, \njet $\geq 5$, inclusive
   in \mht.}
\end{figure}

 \begin{figure}[h!]
  \centering
  \includegraphics[width=0.8\textwidth]{figures/btagformula/pull.pdf} 
  \caption{\label{fig:pull} Pull Distribution of prediction from formula to raw MC}
\end{figure}

\subsection{Systematic uncertainties on transfer factors\label{sec:btag-syst}}
Predictions from formula method are treated in the same way as raw MC yields, 
and hence subject to all systematic sources in the analysis. For the data driven normalisation 
uncertainties which affect the total number of events in each (\njet,~\nb,~\scalht) bin, 
most of the systematics are derived inclusive in \nb. Formula method only changes
the W/\ttbar admixture closure test in Section~\ref{sec:tfSyst_WttAd}. 
The corresponding result is shown in Figure~\ref{fig:closureBTag-formula}.

The systematic on transfer factors from btag scale factors is tested by varying 
the btag scale factors up and down. The results are shown in
 from Figure~\ref{fig:tfSyst_bsf_muToZinv-formula} to Figure~\ref{fig:tfSyst_bsf_muToTtw-formula}.
They are typically in the range of $1-5\%$.


\begin{figure}[h!]
  \begin{center}
    \subfigure[]{\includegraphics[width=0.7\textwidth]{figures/closureTests/eq0b_eq1b_muonsym__noFit.pdf}} \\
    ~~
    \subfigure[]{\includegraphics[width=0.7\textwidth]{figures/closureTests/eq0b_eq1b_muonasym__noFit.pdf}} 
    \caption{Data-driven tests probing the W and \ttbar admixture 
      in each \njet category (open symbols) overlaid on top of the systematic
      uncertainty estimates used for each of the seven \scalht bins
      (shaded bands), from formula method.
      The symmetric (asymmetric) jet topologies are shown in the top (bottom) plot.      
    }
    \label{fig:closureBTag-formula}
  \end{center} 
\end{figure}

\begin{figure}[!h]
  \centering
  \subfigure[b-tag SF up variation]{
    \includegraphics[width=0.5\textwidth]{figures/btagformula/Zinv_Mu/bsfWeight_UpRatio.pdf}
  } ~~
  \subfigure[b-tag SF down variation]{
    \includegraphics[width=0.5\textwidth]{figures/btagformula/Zinv_Mu/bsfWeight_DownRatio.pdf}
  }\\

  \caption{\label{fig:tfSyst_bsf_muToZinv-formula} The relative change in the
  $\mj \rightarrow (\znunu)$ transfer
  factors when varying b-tag SF in MC within its uncertainties, from formula method, 
  as a function of \scalht and jet category. 
  Variations corresponding to $+1\sigma$ ($-1\sigma$) are shown in the left (right) figure. 
  }
\end{figure}

\begin{figure}[!h]
  \centering
  \subfigure[b-tag SF up variation]{
    \includegraphics[width=0.5\textwidth]{figures/btagformula/Zinv_DiMu/bsfWeight_UpRatio.pdf}
  } ~~
  \subfigure[b-tag SF down variation]{
    \includegraphics[width=0.5\textwidth]{figures/btagformula/Zinv_DiMu/bsfWeight_DownRatio.pdf}
  }\\

  \caption{\label{fig:tfSyst_bsf_mumuToZinv-formula} The relative change in
  the $\mmj \rightarrow (\znunu)$ transfer
  factors when varying b-tag SF in MC within its uncertainties, from formula method,
  as a function of \scalht and jet category. 
  Variations corresponding to $+1\sigma$ ($-1\sigma$) are shown in the left (right) figure. 
  }
\end{figure}

\begin{figure}[!h]
  \centering
  \subfigure[b-tag SF up variation]{
    \includegraphics[width=0.5\textwidth]{figures/btagformula/Zinv_Pho/bsfWeight_UpRatio.pdf}
  } ~~
  \subfigure[b-tag SF down variation]{
    \includegraphics[width=0.5\textwidth]{figures/btagformula/Zinv_Pho/bsfWeight_DownRatio.pdf}
  }\\

  \caption{\label{fig:tfSyst_bsf_gjToZinv-formula} The relative change in the
  $\gj \rightarrow (\znunu)$ transfer
  factors when varying b-tag SF in MC within its uncertainties, from formula method, 
  as a function of \scalht and jet category. 
  Variations corresponding to $+1\sigma$ ($-1\sigma$) are shown in the left (right) figure. 
  }
\end{figure}

\begin{figure}[!h]
  \centering
  \subfigure[b-tag SF up variation]{
    \includegraphics[width=0.5\textwidth]{figures/btagformula/Ttw_Mu/bsfWeight_UpRatio.pdf}
  } ~~
  \subfigure[b-tag SF down variation]{
    \includegraphics[width=0.5\textwidth]{figures/btagformula/Ttw_Mu/bsfWeight_DownRatio.pdf}
  }\\

  \caption{\label{fig:tfSyst_bsf_muToTtw-formula} The relative change in the $\mj \rightarrow \mathrm{tt+W}$ transfer
  factors when varying b-tag SF in MC within its uncertainties, from formula, 
  as a function of \scalht and jet category.
  Variations corresponding to $+1\sigma$ ($-1\sigma$) are shown in the left (right) figure. 
  }
\end{figure}


\subsection{Binning and systematic uncertainties in \mht dimension}
For a given (\njet, \nb,\scalht) bin, the threshold of the last \mht bin is 
motivated by a requirement on the statistic power in MC samples, i.e. statistical
uncertainty on this last bin to be less than 50\%. In bins with $n_{\rm b} \geq
3$, the formula method allows pushing the \mht threshold further given the
same requirement.

There are two components concerning the MC statistical uncertainties with 
the formula method, the MC statistical uncertainty from $N(n_{\textrm{b}}^{\textrm{gen}},
n_{\textrm{c}}^{\textrm{gen}}, n_{\textrm{l}}^{\textrm{gen}})$ in equation~\ref{equ:btag-formula}, and the 
MC statistical uncertainty from $\epsilon$, $f_{\rm c}$, and $f_{\rm light}$.
The former uncertainty is the same across the \nb dimension, for each (\njet,
\scalht,\mht) bin. The later uncertainty is determined for each $n_{\rm b}$, by 
varying $\epsilon$, $f_{\rm c}$, and $f_{\rm light}$ up and down within their 
statistical error. The two statistical uncertainties are then added in quadrature for each 
(\njet,\nb,\scalht,\mht) bin. The last \mht bin is required to have such
 statistical uncertainty $< 50\%$ for the EWK component.

The latter statistical uncertainty mentioned above are used to 
build alternative templates in \mht dimension, correlated across the \nb dimension, 
as an extra source of systematics in Section~\ref{sec:mcSystStudiesShape}.

Figure~\ref{fig:mhtShape_ge5j_ge3b_ht800} compares the \mht distribution from
the formula method and raw MC, in one of the most sensitive bins in the analysis.
 and figure~\ref{fig:mhtShapeErr_ge5j_ge3b_ht800} compares the associated 
 statistical uncertainties. Reduced uncertainties show better control 
  of extreme \mht tail in high \nb bins.

Figure~\ref{fig:lastMhtBin} shows thresholds on last \mht bins for each (\njet,
~\nb,~\scalht) category, with the criterion defined above.


\begin{figure}[h!]
  \centering
  \includegraphics[width=0.7\textwidth]{figures/btagformula/GoodMHTShape_ge5j_ge3b.pdf} 
  \caption{\label{fig:mhtShape_ge5j_ge3b_ht800} \mht distribution from formula
   method (Blue) and raw MC (Red) for the bin \scalht $800-\infty$, \njet $\geq 5$, \nb $\geq 3$.}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.7\textwidth]{figures/btagformula/GoodMHTShapeErr_ge5j_ge3b.pdf} 
  \caption{\label{fig:mhtShapeErr_ge5j_ge3b_ht800} Statistical uncertainty on \mht 
  distribution from formula method (Blue) and raw MC (Red) for the bin
  \scalht $800-\infty$, \njet $\geq 5$, \nb $\geq 3$.}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.8\textwidth]{figures/btagformula/Ewk_lastMhtBin.pdf} 
  \caption{\label{fig:lastMhtBin} Thresholds on last \mht bin for each (\njet,
  ~\nb,~\scalht) category}
\end{figure}


\subsection{Performance}
The formula method brings extra sensivity to a wide range of SUSY models with final
states enriched in b-jets.
Especially it enhances the statistical power in bins dominated by the backgrounds 
with mis-tagging, because mis-tagged rates are generally much smaller than 
btagging efficiency. The sensitivity of the analysis with the formula method is 
tested by comparing expected significances with formula method and raw MC, 
at 8~\ifb. The test is performed with \mht binning of 100 \gev bin 
width, with last \mht bin being $800-\infty$.

Table~\ref{tab:t1bbbb-formula-8fb},~\ref{tab:t1tttt-formula-8fb},
~\ref{tab:t1ttbb-formula-8fb},~\ref{tab:t2tt-formula-8fb},~\ref{tab:t5ttcc-formula-8fb} 
show expected significances for some benchmark models for 5 SUSY models, T1bbbb, 
T1tttt, T1ttbb, T2tt and T5ttcc. General improvements, in range of 10\% to 30\%
 are observed, prominantly in uncompressed scenarios. There are a few slight 
 degradation due to shifted background central values.

%\input{tables/btagformula/compare_2p2fb_T1bbbb.tex}
\input{tables/btagformula/compare_8fb_T1bbbb.tex}
\input{tables/btagformula/compare_8fb_T1tttt.tex}
\input{tables/btagformula/compare_8fb_T1ttbb.tex}
\input{tables/btagformula/compare_8fb_T2tt.tex}
\input{tables/btagformula/compare_8fb_T5ttcc.tex}














